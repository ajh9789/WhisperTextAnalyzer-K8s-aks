name: ğŸ§¹ Delete Old Workflow Runs  # GitHub Actions ì‹¤í–‰ ê¸°ë¡ ìë™ ì •ë¦¬ ì›Œí¬í”Œë¡œ

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš© (Actions íƒ­ì—ì„œ ì§ì ‘ ì‹¤í–‰ ê°€ëŠ¥)
  schedule:
    - cron: '0 4 * * 0'  # ì£¼ 1íšŒ ì¼ìš”ì¼ ì˜¤ì „ 4ì‹œ(UTC)ì— ìë™ ì‹¤í–‰í•˜ë ¤ë©´ ì´ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”
  # 0:ë¶„    â†’ 0ë¶„ (ì •ê°)
  # 4:ì‹œ    â†’ 4ì‹œ
  # *:ì¼    â†’ ë§¤ì¼
  # *:ì›”    â†’ ë§¤ì›”
  # 0:ìš”ì¼ â†’ ì¼ìš”ì¼ (0=ì¼, 6=í†  ê¸°ì¤€)

jobs:
  cleanup:
    runs-on: ubuntu-latest  # Ubuntu ìµœì‹  í™˜ê²½ì—ì„œ ì‹¤í–‰

    steps:
      - name: ğŸ“¥ Checkout repository  # ë¨¼ì € GitHub ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install GitHub CLI  # GitHub CLI(gh) ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install gh -y

      - name: ğŸ”‘ Authenticate with PAT  # Personal Access Tokenìœ¼ë¡œ gh CLI ì¸ì¦
        run: |
          echo "${{ secrets.GHCR_PAT }}" | gh auth login --with-token

      - name: ğŸ§¹ Delete old workflow runs (keep latest 30)
        run: | # ìµœì‹  30ê°œ ì œì™¸í•˜ê³  ë‚˜ë¨¸ì§€ë¥¼ ìŠ¬ë¼ì´ìŠ¤í•´ì„œ ì‚­ì œ
          echo "ğŸ§¹ Keeping latest 30 runs of 'docker-multi-build.yml' and deleting the rest..."
          
          run_ids=$(gh run list \
            --workflow docker-multi-build.yml \
            --limit 100 \
            --json databaseId \
            -q '.[].databaseId')
          
          index=0 
          for run_id in $run_ids; do
            if [ $index -ge 30 ]; then
              echo "ğŸ—‘ï¸ Deleting run: $run_id"
              yes | gh run delete $run_id
            fi
            index=$((index+1))
          done
